<div class="p-4 md:p-6 min-h-screen bg-primary-blue "
     (touchstart)="onTouchStart($event)"
     (touchend)="onTouchEnd($event)">

 <!-- Encabezado -->
<div class="flex flex-wrap items-center justify-between gap-2 mb-4">

  <!-- Flechas y título -->
  <!-- Flechas y título -->
<div class="flex items-center gap-3 flex-shrink-0 relative overflow-hidden w-64">

  <!-- Botón Prev -->
  <button *ngIf="view === 'month'" (click)="prevMonth()" class="px-2 py-1 text-white rounded border hover:bg-primary-orange">←</button>
  <button *ngIf="view === 'week'" (click)="prevWeek()" class="px-2 py-1 text-white rounded border hover:bg-primary-orange">←</button>
  <button *ngIf="view === 'year'" (click)="prevYear()" class="px-2 py-1 text-white rounded border hover:bg-primary-orange">←</button>

  <!-- Contenedor animado -->
  <div 
    class="flex-1 text-center text-lg md:text-xl text-white font-semibold capitalize transition-transform duration-300 ease-out"
    [ngClass]="{
      'translate-x-0 opacity-100': true,
      'translate-x-full opacity-0 md:-translate-x-full': animating && direction === 'prev',
      'translate-x-full opacity-0': animating && direction === 'next'
    }"
    (transitionend)="animating = false"
  >
    <ng-container [ngSwitch]="view">
      <span *ngSwitchCase="'month'">{{ monthLabel() }}</span>
      <span *ngSwitchCase="'week'">Week of {{ currentWeek[0].iso }} <br> to {{ currentWeek[6].iso }}</span>
      <span *ngSwitchCase="'year'">{{ selectedYear }}</span>
    </ng-container>
  </div>

  <!-- Botón Next -->
  <button *ngIf="view === 'month'" (click)="nextMonth()" class="px-2 py-1 text-white rounded border hover:bg-primary-orange">→</button>
  <button *ngIf="view === 'week'" (click)="nextWeek()" class="px-2 py-1 text-white rounded border hover:bg-primary-orange">→</button>
  <button *ngIf="view === 'year'" (click)="nextYear()" class="px-2 py-1 text-white rounded border hover:bg-primary-orange">→</button>
</div>


  <!-- Selector de vista + botones -->
  <div class="flex flex-wrap gap-2 items-center order-last md:order-none">
    <!-- Selector de vista -->
    <div class="relative">
      <select [(ngModel)]="view"
              class="px-3 py-1 rounded border-2 bg-primary-blue text-white hover:bg-primary-orange text-sm md:text-lg ">
        <option value="month">Month</option>
        <option value="week">Week</option>
        <option value="year">Year</option>
        <option value="day">Day</option>
      </select>
    </div>

    <!-- Botones -->
    <button (click)="goToday()" class="px-3 py-1 text-white rounded border-2 hover:bg-primary-orange text-sm md:text-lg">Today</button>
    <button (click)="openEventForm()" class="px-3 py-1 rounded border-2 bg-primary-blue text-white hover:bg-primary-orange text-sm md:text-lg">+ Event</button>
    <button *ngIf="view !== 'day'" 
        (click)="openDayModal()" 
        [disabled]="!selectedDate()"
        class="px-3 py-1 rounded bg-primary-blue border-2 hover:bg-primary-orange text-white disabled:bg-gray-300 disabled:cursor-not-allowed text-sm md:text-lg">
  View
</button>
<div *ngIf="view === 'day'" class="flex gap-2 items-center">
  <input type="date" [(ngModel)]="dayPickerDate" 
         (change)="goToDay()"
         class="px-2 py-1 rounded border" />
</div>
  </div>

</div>

  <!-- VISTA MES -->
<div *ngIf="view === 'month'">
  <!-- Días de la semana -->
  <div class="grid grid-cols-7 text-center text-xs md:text-sm font-medium text-white">
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  </div>

  <!-- Contenedor de grilla con animación -->
  <div class="mt-2 relative overflow-hidden h-[calc(28*6+2rem)]">
    
    <!-- Grilla animada -->
    <div 
      class="grid grid-cols-7 gap-1 md:gap-2 relative z-0 transition-transform duration-300 ease-out"
      [ngStyle]="{'transform': animating ? (direction === 'next' ? 'translateX(-100%)' : 'translateX(100%)') : 'translateX(0)'}"
      (transitionend)="animating = false"
    >
      <ng-container *ngFor="let week of weeks()">
        <ng-container *ngFor="let day of week">
          <div class="h-24 md:h-28 lg:h-32 rounded border-4 text-white border-stone-300 p-2 flex flex-col cursor-pointer overflow-hidden hover:bg-secondary-blue"
               [ngClass]="{
                 'opacity-50 bg-gray-400': !day.inCurrentMonth,
                 'ring-2 ring-primary-orange': day.isToday,
                 'bg-secondary-blue': selectedDate() === day.iso
               }"
               (click)="selectDay(day)">
            <div class="text-xs md:text-lg font-medium text-right">{{ day.date.getDate() }}</div>
          </div>
        </ng-container>
      </ng-container>
    </div>

    <!-- Spans de eventos -->
    <div class="absolute inset-0 pointer-events-none z-10 overflow-hidden">
      <ng-container *ngFor="let span of eventSpans()">
        <div class="absolute bg-blue-600 text-white text-xs md:text-sm px-2 rounded truncate"
          [ngClass]="span.event.color || 'bg-blue-600'"
          [style.top]="'calc(' + (span.weekIndex * 100 / weeks().length) + '% + ' + (span.row * 22 + 40) + 'px)'"
          [style.left]="'calc(' + (span.colStart * 100 / 7) + '% + 8px)'"
          [style.width]="'calc(' + ((span.colEnd - span.colStart + 1) * 100 / 7) + '% - 18px)'"
          [style.height]="'20px'"
          [title]="span.event.title"
          [class.pointer-events-auto]="span.event.id.startsWith('more-')"
          [class.cursor-pointer]="span.event.id.startsWith('more-')"
          [class.bg-gray-500]="span.event.id.startsWith('more-')"
          (click)="span.event.id.startsWith('more-') ? openDayModalFromMore(span) : null">
          {{ span.event.title }}
        </div>
      </ng-container>
    </div>

  </div>
</div>


  <ng-container *ngIf="view === 'day'">
  <app-day-view 
    [selectedDate]="selectedDate()" 
    [events]="eventsForSelectedDate" 
    (deleteEvent)="deleteEvent($event)"
    >
  </app-day-view>
</ng-container>


  <!-- VISTA SEMANA -->
  <app-week-view 
    *ngIf="view === 'week'"
    [events]="events()"
    [selectedDate]="selectedDate()"
    (selectedDateChange)="onWeekDaySelected($event)"
    [eventSpans]="eventSpans()"
    (openDayModal)="showDayModal.set(true)"
    (openEventForm)="showEventForm.set(true)"
    [animating]="animating"
    [direction]="direction"
    >
   </app-week-view>


  <!-- VISTA AÑO -->
  <div *ngIf="view === 'year'" class="w-full h-full">
    <app-year-view [year]="selectedYear"
    (monthSelected)="switchToMonth($event)"
    [animating]="animating"
    [direction]="direction"
    ></app-year-view>
  </div>
</div>


 <div *ngIf="showEventForm()"
       class="absolute top-16 mt-1 right-0 bg-white border shadow-lg p-4 rounded w-80 z-50">

    <h2 class="text-lg text-center font-semibold">New event</h2>
    
    <div *ngIf="eventFormError()" class="text-red-600 text-sm font-medium">
      {{ eventFormError() }}
    </div>

    <!-- Título -->
    <input type="text" [(ngModel)]="newEvent.title" placeholder="Event title" 
           class="w-full border rounded px-2 py-1" (input)="eventFormError.set(null)"  />

    <!-- Fecha y hora de inicio -->
    <label class="text-sm">Start:</label>
    <div class="flex gap-2">
      <input type="date" [(ngModel)]="newEvent.start" class="w-1/2 border rounded px-2 py-1" />
      <input type="time" [(ngModel)]="newEvent.hstart" class="w-1/2 border rounded px-2 py-1" />
    </div>

    <!-- Fecha y hora de fin -->
    <label class="text-sm">End:</label>
    <div class="flex gap-2">
      <input type="date" [(ngModel)]="newEvent.end" class="w-1/2 border rounded px-2 py-1" />
      <input type="time" [(ngModel)]="newEvent.hend" class="w-1/2 border rounded px-2 py-1" />
    </div>

    <!-- Selector de color -->
    <label class="text-sm">Color:</label>
    <div class="flex gap-2">
      <button type="button" 
              (click)="newEvent.color='bg-blue-500'" 
              [ngClass]="{'ring-2 ring-black': newEvent.color === 'bg-blue-500'}" 
              class="w-6 h-6 rounded bg-blue-500"></button>

      <button type="button" 
              (click)="newEvent.color='bg-green-500'" 
              [ngClass]="{'ring-2 ring-black': newEvent.color === 'bg-green-500'}" 
              class="w-6 h-6 rounded bg-green-500"></button>

      <button type="button" 
              (click)="newEvent.color='bg-orange-500'" 
              [ngClass]="{'ring-2 ring-black': newEvent.color === 'bg-orange-500'}" 
              class="w-6 h-6 rounded bg-orange-500"></button>

      <button type="button" 
              (click)="newEvent.color='bg-rose-400'" 
              [ngClass]="{'ring-2 ring-black': newEvent.color === 'bg-rose-400'}" 
              class="w-6 h-6 rounded bg-rose-400"></button>
    </div>

    <div class="flex justify-end gap-2 mt-2">
      <button (click)="showEventForm.set(false)" class="px-3 py-1 rounded border">Cancel</button>
      <button (click)="saveEvent()" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
    </div>

  </div>


<!-- Modal detalle día -->
<div *ngIf="showDayModal()" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg w-96 max-h-[80vh] overflow-y-auto space-y-4">
    <div class="flex justify-between items-center">
      <h2 class="text-lg font-semibold">Events of {{ selectedDate() }}</h2>
      <button (click)="closeDayModal()" class="text-gray-500 hover:text-gray-700">✕</button>
    </div>

    <div *ngIf="getEventsForDay(selectedDate() || '').length > 0; else noEvents" class="space-y-2">
      <div *ngFor="let ev of getEventsForDay(selectedDate()!)" class="px-3 py-2 rounded flex justify-between items-center bg-blue-100">
        
        <div class="flex-1">
          <div class="font-medium">{{ ev.title }}</div>
          <div class="text-xs text-gray-700">{{ ev.start }} {{ ev.hstart }}  - {{ ev.end }} {{ ev.hend }}</div>
        </div>

        <div class="flex gap-1 ml-2">

          <!-- Botón Delete -->
          <button (click)="deleteEvent(ev.id)" class="px-2 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600">
            Delete
          </button>
        </div>
      </div>
    </div>

    <ng-template #noEvents>
      <p class="text-gray-500 text-sm">No events for this day.</p>
    </ng-template>
  </div>
</div>
