<div class="p-4 md:p-6">
 <!-- Encabezado -->
<div class="flex flex-wrap items-center justify-between gap-2 mb-4">

  <!-- Flechas y título -->
  <div class="flex items-center gap-3 flex-shrink-0">
    <button *ngIf="view === 'month'" (click)="prevMonth()" class="px-2 py-1 rounded border hover:bg-gray-50">←</button>
    <button *ngIf="view === 'week'" (click)="prevWeek()" class="px-2 py-1 rounded border hover:bg-gray-50">←</button>

    <div *ngIf="view === 'month'" class="text-lg md:text-xl font-semibold capitalize">{{ monthLabel() }}</div>
    <div *ngIf="view === 'week'" class="text-lg md:text-xl font-semibold capitalize text-center">
      Week of {{ currentWeek[0].iso }} <br> to {{ currentWeek[6].iso }}
    </div>

    <button *ngIf="view === 'month'" (click)="nextMonth()" class="px-2 py-1 rounded border hover:bg-gray-50">→</button>
    <button *ngIf="view === 'week'" (click)="nextWeek()" class="px-2 py-1 rounded border hover:bg-gray-50">→</button>
  </div>

  <!-- Selector de vista + botones -->
  <div class="flex flex-wrap gap-2 items-center order-last md:order-none">
    <!-- Selector de vista -->
    <div class="relative">
      <select [(ngModel)]="view"
              class="px-3 py-1 rounded border hover:bg-gray-50 focus:ring-2 focus:ring-blue-400">
        <option value="month">Month</option>
        <option value="week">Week</option>
        <option value="year">Year</option>
      </select>
    </div>

    <!-- Botones -->
    <button (click)="goToday()" class="px-3 py-1 rounded border hover:bg-gray-50 text-sm md:text-lg">Today</button>
    <button (click)="openEventForm()" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700 text-sm md:text-lg">+ Event</button>
    <button (click)="openDayModal()" [disabled]="!selectedDate()"
      class="px-3 py-1 rounded bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-sm md:text-lg">
      View
    </button>
  </div>

</div>
  <!-- VISTA MES -->
  <div *ngIf="view === 'month'">
    <!-- Días de la semana -->
    <div class="grid grid-cols-7 text-center text-xs md:text-sm font-medium text-black/70">
      <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>

    <div class="mt-2 relative overflow-hidden">
      <!-- Spans multi-día y single-day -->
      <div class="absolute inset-0 pointer-events-none z-10 overflow-hidden">
        <ng-container *ngFor="let span of eventSpans()">
          <div class="absolute bg-blue-600 text-white text-xs md:text-sm px-2 rounded truncate"
            [ngClass]="span.event.color || 'bg-blue-600'"
            [style.top]="'calc(' + (span.weekIndex * 100 / weeks().length) + '% + ' + (span.row * 22 + 40) + 'px)'"
            [style.left]="'calc(' + (span.colStart * 100 / 7) + '% + 8px)'"
            [style.width]="'calc(' + ((span.colEnd - span.colStart + 1) * 100 / 7) + '% - 18px)'"
            [style.height]="'20px'"
            [title]="span.event.title"
            [class.pointer-events-auto]="span.event.id.startsWith('more-')"
            [class.cursor-pointer]="span.event.id.startsWith('more-')"
            [class.bg-gray-500]="span.event.id.startsWith('more-')"
            (click)="span.event.id.startsWith('more-') ? openDayModalFromMore(span) : null">
            {{ span.event.title }}
          </div>
        </ng-container>
      </div>

      <!-- Grilla -->
      <div class="grid grid-cols-7 gap-1 md:gap-2 relative z-0">
        <ng-container *ngFor="let week of weeks()">
          <ng-container *ngFor="let day of week">
            <div class="h-24 md:h-28 lg:h-32 rounded border-4 border-stone-300 p-2 flex flex-col cursor-pointer overflow-hidden hover:bg-blue-100"
                 [ngClass]="{
                   'opacity-50 bg-gray-50': !day.inCurrentMonth,
                   'ring-2 ring-blue-400': day.isToday,
                   'bg-blue-100': selectedDate() === day.iso
                 }"
                 (click)="selectDay(day)">
              <div class="text-xs md:text-lg font-medium text-right">{{ day.date.getDate() }}</div>
            </div>
          </ng-container>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- VISTA SEMANA -->
  <app-week-view 
    *ngIf="view === 'week'"
    [events]="events()"
    [selectedDate]="selectedDate()"
    (selectedDateChange)="onWeekDaySelected($event)"
    [eventSpans]="eventSpans()"
    (openDayModal)="showDayModal.set(true)"
    (openEventForm)="showEventForm.set(true)"
    >
   </app-week-view>


  <!-- VISTA AÑO -->
  <div *ngIf="view === 'year'" class="w-full h-full">
    <app-year-view [year]="selectedYear"
    (monthSelected)="switchToMonth($event)"
    ></app-year-view>
  </div>
</div>


 <div *ngIf="showEventForm()"
       class="absolute top-16 mt-1 right-0 bg-white border shadow-lg p-4 rounded w-80 z-50">

    <h2 class="text-lg text-center font-semibold">New event</h2>
    
    <div *ngIf="eventFormError()" class="text-red-600 text-sm font-medium">
      {{ eventFormError() }}
    </div>

    <!-- Título -->
    <input type="text" [(ngModel)]="newEvent.title" placeholder="Event title" 
           class="w-full border rounded px-2 py-1" (input)="eventFormError.set(null)"  />

    <!-- Fecha y hora de inicio -->
    <label class="text-sm">Start:</label>
    <div class="flex gap-2">
      <input type="date" [(ngModel)]="newEvent.start" class="w-1/2 border rounded px-2 py-1" />
      <input type="time" [(ngModel)]="newEvent.hstart" class="w-1/2 border rounded px-2 py-1" />
    </div>

    <!-- Fecha y hora de fin -->
    <label class="text-sm">End:</label>
    <div class="flex gap-2">
      <input type="date" [(ngModel)]="newEvent.end" class="w-1/2 border rounded px-2 py-1" />
      <input type="time" [(ngModel)]="newEvent.hend" class="w-1/2 border rounded px-2 py-1" />
    </div>

    <!-- Selector de color -->
    <label class="text-sm">Color:</label>
    <div class="flex gap-2">
      <button type="button" 
              (click)="newEvent.color='bg-blue-500'" 
              [ngClass]="{'ring-2 ring-black': newEvent.color === 'bg-blue-500'}" 
              class="w-6 h-6 rounded bg-blue-500"></button>

      <button type="button" 
              (click)="newEvent.color='bg-green-500'" 
              [ngClass]="{'ring-2 ring-black': newEvent.color === 'bg-green-500'}" 
              class="w-6 h-6 rounded bg-green-500"></button>

      <button type="button" 
              (click)="newEvent.color='bg-orange-500'" 
              [ngClass]="{'ring-2 ring-black': newEvent.color === 'bg-orange-500'}" 
              class="w-6 h-6 rounded bg-orange-500"></button>

      <button type="button" 
              (click)="newEvent.color='bg-rose-400'" 
              [ngClass]="{'ring-2 ring-black': newEvent.color === 'bg-rose-400'}" 
              class="w-6 h-6 rounded bg-rose-400"></button>
    </div>

    <div class="flex justify-end gap-2 mt-2">
      <button (click)="showEventForm.set(false)" class="px-3 py-1 rounded border">Cancel</button>
      <button (click)="saveEvent()" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
    </div>

  </div>


<!-- Modal detalle día -->
<div *ngIf="showDayModal()" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg w-96 max-h-[80vh] overflow-y-auto space-y-4">
    <div class="flex justify-between items-center">
      <h2 class="text-lg font-semibold">Events of {{ selectedDate() }}</h2>
      <button (click)="closeDayModal()" class="text-gray-500 hover:text-gray-700">✕</button>
    </div>

    <div *ngIf="getEventsForDay(selectedDate() || '').length > 0; else noEvents" class="space-y-2">
      <div *ngFor="let ev of getEventsForDay(selectedDate()!)" class="px-3 py-2 rounded flex justify-between items-center bg-blue-100">
        
        <div class="flex-1">
          <div class="font-medium">{{ ev.title }}</div>
          <div class="text-xs text-gray-700">{{ ev.start }} {{ ev.hstart }}  - {{ ev.end }} {{ ev.hend }}</div>
        </div>

        <div class="flex gap-1 ml-2">

          <!-- Botón Delete -->
          <button (click)="deleteEvent(ev.id)" class="px-2 py-1 text-sm bg-red-500 text-white rounded hover:bg-red-600">
            Delete
          </button>
        </div>
      </div>
    </div>

    <ng-template #noEvents>
      <p class="text-gray-500 text-sm">No events for this day.</p>
    </ng-template>
  </div>
</div>
