<div class="p-4 md:p-6">
  <!-- encabezado -->
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-3">
      <button (click)="prevMonth()" class="px-2 py-1 rounded border hover:bg-gray-50">←</button>
      <div class="text-xl md:text-2xl font-semibold capitalize">
        {{ monthLabel() }}
      </div>
      <button (click)="nextMonth()" class="px-2 py-1 rounded border hover:bg-gray-50">→</button>
    </div>
    <div class="flex gap-2">
      <button (click)="goToday()" class="px-3 py-1 rounded border hover:bg-gray-50">Today</button>
      <button (click)="openEventForm()" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">
        + Event
      </button>
      <button (click)="openDayModal()"
        [disabled]="!selectedDate()"
        class="px-3 py-1 rounded bg-green-600 text-white hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed">
        View
      </button>
    </div>
  </div>

  <div class="grid grid-cols-7 text-center text-xs md:text-sm font-medium text-black/70">
    <div>Sun</div>
    <div>Mon</div>
    <div>Tue</div>
    <div>Wed</div>
    <div>Thu</div>
    <div>Fri</div>
    <div>Sat</div>
  </div>

  <div class="mt-2 relative"> 
    <!-- Spans de eventos multi-día -->
    <div class="absolute inset-0 pointer-events-none z-10">
      <ng-container *ngFor="let span of eventSpans()">
        <div 
          class="absolute bg-blue-600 text-white text-xs md:text-sm px-2 rounded truncate"
          [style.top]="'calc(' + (span.weekIndex * 100 / weeks().length) + '% + ' + (span.row * 24) + 'px)'"
          [style.left]="'calc(' + (span.colStart * 100 / 7) + '% + 2px)'"
          [style.width]="'calc(' + ((span.colEnd - span.colStart + 1) * 100 / 7) + '% - 4px)'"
          [style.height]="'20px'"
          [title]="span.event.title">
          {{ span.event.title }}
        </div>
      </ng-container>
    </div>

    <!-- grilla del calendario -->
    <div class="grid grid-cols-7 gap-1 md:gap-2 relative z-0">
      <ng-container *ngFor="let week of weeks()">
        <ng-container *ngFor="let day of week">
          <div
            class="h-24 md:h-28 lg:h-32 rounded border-4 border-stone-300 p-2 flex flex-col cursor-pointer overflow-hidden hover:bg-blue-100"
            [ngClass]="{
              'opacity-50 bg-gray-50': !day.inCurrentMonth,
              'ring-2 ring-blue-400': day.isToday,
              'bg-blue-100': selectedDate() === day.iso
            }"
            (click)="selectDay(day)"
          >
            <div class="text-xs md:text-lg font-medium text-right">
              {{ day.date.getDate() }}
            </div>

            <!-- eventos de un día -->
            <div class="mt-1 space-y-1 overflow-hidden">
              <ng-container *ngFor="let ev of getEventsForDay(day.iso)">
                <div
                  *ngIf="ev.start === ev.end"
                  class="text-[10px] text-center md:text-sm px-1 rounded bg-blue-600 text-white truncate"
                >
                  {{ ev.title }}
                </div>
              </ng-container>
            </div>
          </div>
        </ng-container>
      </ng-container>
    </div>
  </div>
</div>

<!-- Modal para agregar evento -->
<div *ngIf="showEventForm()" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center modal-overlay z-50">
  <div class="bg-white p-6 rounded-lg w-80 space-y-4">
    <h2 class="text-lg font-semibold">New event</h2>

    <input type="text" [(ngModel)]="newEvent.title"
      placeholder="Event title"
      class="w-full border rounded px-2 py-1" />

    <label class="text-sm">Start:</label>
    <input type="date" [(ngModel)]="newEvent.start" class="w-full border rounded px-2 py-1" />

    <label class="text-sm">end:</label>
    <input type="date" [(ngModel)]="newEvent.end" class="w-full border rounded px-2 py-1" />

    <div class="flex justify-end gap-2">
      <button (click)="showEventForm.set(false)" class="px-3 py-1 rounded border">Cancel</button>
      <button (click)="saveEvent()" class="px-3 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
    </div>
  </div>
</div>

<!-- Modal de detalle -->
<div *ngIf="showDayModal()" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center modal-overlay z-50">
  <div class="bg-white p-6 rounded-lg w-96 max-h-[80vh] overflow-y-auto space-y-4">
    <div class="flex justify-between items-center">
      <h2 class="text-lg font-semibold">Events of {{ selectedDate() }}</h2>
      <button (click)="closeDayModal()" class="text-gray-500 hover:text-gray-700">✕</button>
    </div>

    <div *ngIf="getEventsForDay(selectedDate() || '').length > 0; else noEvents" class="space-y-2">
      <div *ngFor="let ev of getEventsForDay(selectedDate()!)"
           class="px-3 py-2 rounded bg-blue-100 text-blue-800">
        <div class="font-medium">{{ ev.title }}</div>
        <div class="text-xs text-gray-500">{{ ev.start }} - {{ ev.end }}</div>
      </div>
    </div>

    <ng-template #noEvents>
      <p class="text-gray-500 text-sm">No events for this day.</p>
    </ng-template>
  </div>
</div>
